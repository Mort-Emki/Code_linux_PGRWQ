# DataHandler模块功能报告

## 概述
DataHandler是一个优化的数据处理类，专注于水质预测模型的数据预处理和标准化，通过预计算和缓存机制提升性能。

## 核心功能模块

### 1. 初始化与配置
- **`__init__()`**: 初始化数据处理器，设置预计算选项
- **`initialize()`**: 执行完整的数据预处理流程，包括预分组、属性构建、标准化器初始化

### 2. 数据预处理模块

#### 预分组优化
- **`_precompute_groups()`**: 按COMID预分组时间序列数据，避免重复分组操作
- 缓存结果到 `_cached_groups`，显著提升后续查询性能

#### 属性处理
- **`_build_attribute_dictionary()`**: 构建河段属性字典，处理缺失值和类型转换
- **`_precompute_standardized_attributes()`**: 预标准化所有属性数据，避免重复标准化

#### 标准化处理
- **`_initialize_scalers()`**: 初始化时间序列和属性标准化器
- **`_get_sample_data()`**: 获取样本数据用于创建标准化器

### 3. 滑动窗口处理
- **`_precompute_sliding_windows()`**: 可选的预计算滑动窗口功能
- 支持内存换时间的优化策略，适用于重复查询场景

### 4. 数据获取接口

#### 基础数据获取
- **`get_groups()`**: 获取预分组数据，支持指定COMID列表
- **`get_standardized_attr_dict()`**: 获取完整的标准化属性字典

#### 训练数据准备
- **`get_standardized_data()`**: 获取标准化的训练数据
  - 自动选择最优路径：预计算缓存 vs 实时计算
  - 支持灵活的参数配置（时间窗口、目标列等）

#### 批量处理
- **`prepare_batch_prediction_data()`**: 优化的批量预测数据准备
- **`_prepare_batch_from_cache()`**: 从缓存快速准备批量数据
- **`_prepare_batch_realtime()`**: 实时计算批量数据

### 5. 专用数据处理

#### 头部河段处理
- **`prepare_training_data_for_head_segments()`**: 为头部河段准备训练数据
- 自动筛选符合条件的河段，保存训练数据文件

#### 迭代训练支持
- **`prepare_next_iteration_data()`**: 为下一轮迭代准备训练数据
- 支持误差标签计算和数据合并

## 性能优化特性

### 1. 预计算机制
- **预分组**: 一次分组，多次使用
- **预标准化**: 批量标准化属性数据
- **预计算窗口**: 可选的滑动窗口预计算

### 2. 智能路径选择
- 根据数据可用性自动选择最优处理路径
- 缓存优先，实时计算作为备选

### 3. 内存管理
- 使用TimingAndMemoryContext监控资源使用
- 合理的缓存策略，避免内存溢出

## 使用场景

1. **模型训练**: 提供标准化的训练数据集
2. **批量预测**: 高效处理大批量预测请求
3. **迭代训练**: 支持递归水质预测模型的迭代训练流程
4. **数据分析**: 提供预处理后的数据用于分析

## 技术特点

- **类型安全**: 完整的类型注解和None安全检查
- **错误处理**: 健壮的异常处理和数据验证
- **性能优化**: 多层次缓存和预计算策略
- **可配置**: 灵活的参数配置支持不同使用场景